<%- include('../header') %>
        <div class="content">
            <div class="row">
                <%- include('../left') %>
                <div class="right col-9" ng-controller="perMange">
                    <div class="container">
                        <div class="item-head border-bottom">
                            <div class="current">
                               角色管理
                            </div>
                        </div>
                        <div class="item-con">
                            <p><span class="btn btn-sm btn-dark" ng-click="addBtnClick = true">新增角色</span></p>
                            <div class="row">
                                <div class="col-8">
                                    <table class="table">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th scope="col">序号</th>
                                                <th scope="col">角色名</th>

                                                <th scope="col">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="item in roleList">
                                                <th scope="row">{{$index}}</th>
                                                <td><input id="changeRole{{$index}}" value="{{item.name}}" style="border: none;background: none;" disabled></td>

                                                <td><a href="#" data-toggle="modal" data-target="#exampleModalCenter" data-per="{{item.permissions}}" data-role="{{item.name}}">权限</a>|<a href="#" ng-click="changeRoleName($index)">修改</a>|<a href="#" ng-click="delRole($index)">删除</a></td>
                                            </tr>
                                            <tr ng-show="addBtnClick">
                                                <th scope="row">0</th>
                                                <td><input type="text" ng-model="roleName"></td>

                                                <td><span class="btn btn-sm btn-primary" ng-click="addRole()">新增</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLongTitle">修改权限</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <ul id="treeDemo" class="ztree"></ul>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                                                <button type="button" ng-click="perChange()" class="btn btn-primary">保存修改</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        blogAdmin.controller('perMange',function ($scope,$http) {
            var zTreeObj;
            var setting = {
                data: {
                    simpleData: {
                        enable: true, idKey: '_id'
                    }
                },
                edit: { enable: true },
                check: {
                    chkboxType: {Y: 'ps', N: 'ps'},
                    enable: true,
                    chkStyle: 'checkbox'
                }
            };

            $scope.roleList = [];
            $http.get('/api/roleList').then(function (result) {
                $scope.roleList = result.data;
            },function (err) {
                
            });
            $scope.flag = false;
            $scope.changeRoleName = function (index) {
                var oldData;
                (function ($, undefined) {
                    $.fn.setCursorPosition = function () {
                        var el = $(this).get(0);
                        var pos = 0;
                        if ('selectionStart' in el) {
                            el.focus();
                            oldData = el.value;
                            el.setSelectionRange(0,el.value.length);
                        } else if ('selection' in document) {
                            el.focus();
                            var Sel = document.selection.createRange();
                            var SelLength = document.selection.createRange().text.length;
                            Sel.moveStart('character', -el.value.length);
                            pos = Sel.text.length - SelLength;
                        }
                        return pos;
                    }
                })(jQuery);
                var cruID = '#changeRole'+index;
                $scope.flag = true;
                var t = $(cruID).val();
                console.log(window.selectionStart);
                //$(cruID).attr('disabled',false).focus().val(t+' ');
                $(cruID).attr('disabled',false).setCursorPosition();
                $(cruID).blur(function () {
                        $(this).attr('disabled',true);
                        var newData = $(this).val();
                        if(newData != oldData){
                            $http.post('/api/roleUpdate',{name: oldData, newname: newData}).then(function (result) {
                                console.log(result.data);
                            });
                        }else{
                            alert('没有任何修改')
                        }
                    })
            };
            $('#exampleModalCenter').on('show.bs.modal',function (event) {
                var button = $(event.relatedTarget);
                $http.post('/api/perLimitList',{name: button.data('per')})
                    .then(function (result) {
                        $.fn.zTree.init($("#treeDemo"), setting, result.data);
                    },function (err) {
                        console.log(err);
                    });
                $scope.perChange = function () {
                    var zObj = $.fn.zTree.getZTreeObj('treeDemo');
                    var data = zObj.getCheckedNodes();
                    $http.post('/api/perChange',{data:data, role: button.data('role')})
                        .then(function (data) {
                            alert(data.data);
                            location.reload();
                        },function (err) {

                        })
                }
            });
            //添加角色
            $scope.addRole = function () {
                var newName = $scope.roleName;
                $scope.addBtnClick = false;
                $http.post('/api/addRole',{name: newName}).then(function (result) {
                    console.log(result);
                    $scope.roleList.push(result.data);
                })
            }
            $scope.delRole = function (index) {
                var flag = confirm('确定删除' + $scope.roleList[index].name);
                if(flag){
                    $http.post('/api/delRole',{name: $scope.roleList[index].name}).then(function (result) {
                        $scope.roleList.splice(index,1);
                    })
                }
            }
        });
    </script>
</body>
</html>